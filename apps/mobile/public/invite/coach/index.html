<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coach Invitation - Eleve</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #1E293B;
            background: #f1eeff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 480px;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #8B5CF6, #7C3AED);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px 30px;
        }

        .welcome {
            text-align: center;
            margin-bottom: 30px;
        }

        .welcome h2 {
            color: #8B5CF6;
            font-size: 1.8rem;
            margin-bottom: 15px;
        }

        .welcome p {
            color: #64748B;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .org-info {
            background: #F8FAFC;
            padding: 20px;
            border-radius: 12px;
            margin: 30px 0;
            border-left: 4px solid #8B5CF6;
        }

        .org-info h3 {
            color: #1E293B;
            margin-bottom: 8px;
            font-size: 1.2rem;
        }

        .org-info p {
            color: #64748B;
            font-size: 0.95rem;
        }

        .features {
            margin: 30px 0;
        }

        .features h3 {
            color: #1E293B;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .features ul {
            list-style: none;
            padding: 0;
        }

        .features li {
            padding: 8px 0;
            color: #64748B;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .features li::before {
            content: "ðŸŽ¯";
            font-size: 1.2rem;
        }

        .signup-form {
            background: #F8FAFC;
            padding: 30px;
            border-radius: 12px;
            margin: 30px 0;
        }

        .signup-form h3 {
            color: #1E293B;
            margin-bottom: 20px;
            font-size: 1.3rem;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #8B5CF6;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .form-group input:disabled {
            background: #F3F4F6;
            color: #6B7280;
        }

        .password-requirements {
            font-size: 0.85rem;
            color: #6B7280;
            margin-top: 5px;
        }

        .cta-section {
            text-align: center;
            margin: 40px 0 20px;
        }

        .cta-button {
            background: #8B5CF6;
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 15px;
            width: 100%;
        }

        .cta-button:hover {
            background: #7C3AED;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }

        .cta-button:disabled {
            background: #D1D5DB;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .secondary-link {
            color: #64748B;
            text-decoration: none;
            font-size: 0.95rem;
        }

        .secondary-link:hover {
            color: #8B5CF6;
        }

        .error {
            background: #FEF2F2;
            color: #DC2626;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #FECACA;
        }

        .success {
            background: #F0FDF4;
            color: #16A34A;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #BBF7D0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #64748B;
        }

        .footer {
            text-align: center;
            padding: 30px;
            background: #F8FAFC;
            color: #94A3B8;
            font-size: 0.9rem;
        }

        .footer p {
            margin: 5px 0;
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                border-radius: 12px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .content {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }

            .signup-form {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ›¹ Eleve</h1>
            <p>Coach Invitation</p>
        </div>

        <div class="content">
            <div id="loading" class="loading">
                <p>Validating your invitation...</p>
            </div>

            <div id="error" class="error" style="display: none;">
                <p>This invitation link is invalid or has expired.</p>
            </div>

            <div id="main-content" style="display: none;">
                <div class="welcome">
                    <h2>Welcome to the team! ðŸŽ‰</h2>
                    <p>You've been invited to join as a coach on Eleve.</p>
                </div>

                <div class="org-info">
                    <h3 id="org-name">Loading organization...</h3>
                    <p>You'll be joining this academy as a coaching staff member.</p>
                </div>

                <div class="features">
                    <h3>What you'll be able to do:</h3>
                    <ul>
                        <li>Record and review student progress videos</li>
                        <li>Track student achievements and milestones</li>
                        <li>Access detailed progress analytics</li>
                        <li>Communicate with parents and students</li>
                        <li>Award badges and celebrate successes</li>
                    </ul>
                </div>

                <div class="signup-form">
                    <h3>Create Your Coach Account</h3>
                    <form id="signup-form">
                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" required disabled>
                        </div>
                        <div class="form-group">
                            <label for="password">Choose a Password</label>
                            <input type="password" id="password" name="password" required minlength="6">
                            <div class="password-requirements">
                                Minimum 6 characters
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Confirm Password</label>
                            <input type="password" id="confirm-password" name="confirm-password" required>
                        </div>
                    </form>
                    
                    <div id="signup-error" class="error" style="display: none;">
                        <p></p>
                    </div>
                    
                    <div id="signup-success" class="success" style="display: none;">
                        <p>Account created successfully! Opening the app to complete your profile...</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">
                            If the app doesn't open automatically, please open the Eleve app on your device to complete your profile setup.
                        </p>
                    </div>
                </div>

                <div class="cta-section">
                    <button id="create-account-btn" class="cta-button" onclick="createAccount()">
                        Create Account & Get Started
                    </button>
                    <br>
                    <a href="#" class="secondary-link" onclick="declineInvitation()">
                        Decline invitation
                    </a>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>This invitation was sent through Eleve</p>
            <p>Need help? Contact your academy administrator</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://noaeiuejccwfabjhjndy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYWVpdWVqY2N3ZmFiamhqbmR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIwMTk3ODEsImV4cCI6MjA2NzU5NTc4MX0.E33Wv1XDmjxrzxaTYCbbJwVfa7GackRrMYUtLFbvEk4';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Get invitation code from URL
        const invitationCode = window.location.pathname.split('/').pop();
        let invitationData = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            if (!invitationCode) {
                showError('No invitation code found in URL');
                return;
            }

            try {
                // Check invitation status using Supabase
                const { data, error } = await supabase.rpc('check_invitation_status', {
                    invitation_code: invitationCode
                });

                if (error) {
                    throw new Error(error.message);
                }

                if (!data || data.length === 0) {
                    throw new Error('Invalid invitation code');
                }

                invitationData = data[0];
                
                // Check if invitation is valid
                if (invitationData.status !== 'pending') {
                    throw new Error('This invitation has already been used or cancelled');
                }

                // Check if expired
                const expiresAt = new Date(invitationData.expires_at);
                if (expiresAt < new Date()) {
                    throw new Error('This invitation has expired');
                }

                showMainContent();
            } catch (error) {
                console.error('Error validating invitation:', error);
                showError(error.message || 'This invitation link is invalid or has expired.');
            }
        });

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error').querySelector('p').textContent = message;
        }

        function showMainContent() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            
            if (invitationData) {
                document.getElementById('org-name').textContent = invitationData.organization_name || 'Your Academy';
                document.getElementById('email').value = invitationData.email;
            }
        }

        function showSignupError(message) {
            document.getElementById('signup-error').style.display = 'block';
            document.getElementById('signup-error').querySelector('p').textContent = message;
            document.getElementById('signup-success').style.display = 'none';
        }

        function showSignupSuccess() {
            document.getElementById('signup-success').style.display = 'block';
            document.getElementById('signup-error').style.display = 'none';
        }

        async function createAccount() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const createButton = document.getElementById('create-account-btn');

            // Validate form
            if (!email || !password || !confirmPassword) {
                showSignupError('Please fill in all fields');
                return;
            }

            if (password !== confirmPassword) {
                showSignupError('Passwords do not match');
                return;
            }

            if (password.length < 6) {
                showSignupError('Password must be at least 6 characters');
                return;
            }

            // Disable button and show loading
            createButton.disabled = true;
            createButton.textContent = 'Creating Account...';

            try {
                                 // Sign up user with Supabase Auth
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: invitationData.recipient_name,
                            user_role: 'coach'
                        }
                    }
                });

                if (authError) {
                    throw new Error(authError.message);
                }

                // Update invitation status and link to user
                const { error: updateError } = await supabase.rpc('accept_coach_invitation', {
                    invitation_code: invitationCode,
                    user_id: authData.user.id
                });

                if (updateError) {
                    throw new Error(updateError.message);
                }

                // Show success message
                showSignupSuccess();

                // Show profile completion message and redirect
                setTimeout(() => {
                    // Generate deep link for the mobile app with profile completion
                    const profileCompletionUrl = `exp://eleve-app/profile-completion?invitationCode=${invitationCode}&userId=${authData.user.id}`;
                    
                    // Try to open the app, fallback to browser message
                    window.location.href = profileCompletionUrl;
                    
                    // Show fallback instructions after a delay
                    setTimeout(() => {
                        alert('Please open the Eleve app on your device to complete your profile setup. If you don\'t have the app installed, download it from your app store and use this invitation code: ' + invitationCode);
                    }, 3000);
                }, 2000);

            } catch (error) {
                console.error('Error creating account:', error);
                showSignupError(error.message || 'Failed to create account. Please try again.');
                
                // Re-enable button
                createButton.disabled = false;
                createButton.textContent = 'Create Account & Get Started';
            }
        }

        function declineInvitation() {
            const confirmed = confirm('Are you sure you want to decline this invitation?');
            if (confirmed) {
                // Update invitation status to declined
                supabase.rpc('decline_coach_invitation', {
                    invitation_code: invitationCode
                }).then(() => {
                    alert('Invitation declined. You can close this page.');
                }).catch(error => {
                    console.error('Error declining invitation:', error);
                    alert('Invitation declined. You can close this page.');
                });
            }
        }
    </script>
</body>
</html> 